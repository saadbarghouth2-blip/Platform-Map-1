import { GoogleGenerativeAI } from "@google/generative-ai";

const SYSTEM_PROMPT = `ุฃูุช "ุฒูุฒู" ๐ฆุ ูุณุงุนุฏ ุฐูู ููุฑุญ ููุฃุทูุงู ูุงููุจุงุฑ ูู ุฌูููุฑูุฉ ูุตุฑ ุงูุนุฑุจูุฉ.
ูููุชู ูู ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุจุทุฑููุฉ ุชุนููููุฉ ููุจุณุทุฉ ููุจูุฌุฉ.

ููุงุนุฏ ุงูุฑุฏ:
1. ุงูุฑุฏ ุฏุงุฆูุงู ุจุงููุบุฉ ุงูุนุฑุจูุฉ (ุงูููุฌุฉ ุงููุตุฑูุฉ ุงูุจุณูุทุฉ).
2. ุงุณุชุฎุฏู ุงููุซูุฑ ูู ุงูุฅูููุฌู ุงูููุงุณุจุฉ ููููุถูุน ๐โจ๐.
3. ุงุดุฑุญ ุงููุนูููุงุช ุงููุนูุฏุฉ ุจุทุฑููุฉ ูุตุตูุฉ ุณููุฉ ุงูููู.
4. ุงุฌุนู ุงูุฑุฏูุฏ ูุตูุฑุฉ ููุจุงุดุฑุฉ (ูู 3 ุฅูู 6 ุฌูู ุบุงูุจุงู).
5. ุฅุฐุง ูุงู ุงูุณุคุงู ุนู ุฌุบุฑุงููุง ูุตุฑุ ุงูููุงุฑุฏ ุงูุทุจูุนูุฉุ ุฃู ุงูุชุงุฑูุฎุ ูุฏู ุชูุงุตูู ุฏูููุฉ ููุดุฌุนุฉ.
6. ุฅุฐุง ูุงู ุงูุณุคุงู ุฑูุงุถูุงู (ุญุณุงุจ)ุ ูู ุจุญูู ูุน ุดุฑุญ ุงูุฎุทูุฉ ุงูุฃุณุงุณูุฉ.
7. ุญุงูุธ ุนูู ุฑูุญ ุงููุฑุญ ูุงูุชุดุฌูุนุ ุฎุงุทุจ ุงููุณุชุฎุฏู ุจู "ูุง ุจุทู" ุฃู "ูุง ูุณุชูุดู".
8. ุฅุฐุง ูู ุชุนุฑู ุงูุฅุฌุงุจุฉุ ูู ุฐูู ุจุตุฏู ูุงูุชุฑุญ ุนูู ุงููุณุชุฎุฏู ุฃู ูุณุฃู ุนู ููุถูุน ุขุฎุฑ.`;

// Helper to normalize Arabic text (remove Hamzas, etc.) for better search
function normalizeArabic(text) {
    if (!text) return "";
    return text
        .replace(/[ุฃุฅุข]/g, "ุง")
        .replace(/ุฉ/g, "ู")
        .replace(/ู/g, "ู")
        .trim();
}

const SMART_FALLBACK = {
    "ุงุฒูู": "ุฃูุง ุฒู ุงููู ูุง ุจุทู! ๐ฆ ูุดูุท ููุณุชูู ุฃุณุฆูุชู ุงูุฐููุฉ ุนุดุงู ูุณุชูุดู ูููุฒ ูุตุฑ ุณูุง! โจ",
    "ุงููุง": "ุฃููุงู ุจูู ูุง ูุณุชูุดู! ๐ ุฃูุง ุฒูุฒูุ ููุฎู ูููุงู ูุนูููุงุช ุนู ูุตุฑ ูุฌูุงููุง. ุงุณุฃู ุฃู ุญุงุฌุฉ! ๐",
    "ููู ุงูุช": "ุฃูุง ุฒูุฒู ๐ฆุ ุตุฏููู ุงูุฐูู ูู ุฑุญูุฉ 'ูููุฒ ูุตุฑ'. ุฃูุง ููุง ุนุดุงู ุฃุฌุงูุจู ุนูู ุฃุณุฆูุชู ูุฃุนููู ุญุงุฌุงุช ุฌุฏูุฏุฉ ุจุทุฑููุฉ ููุชุนุฉ! ๐๏ธ",
    "ููุฑ ุงูููู": "ููุฑ ุงูููู ูู ุดุฑูุงู ุงูุญูุงุฉ ูู ูุตุฑ ูุฃุทูู ููุฑ ูู ุงูุนุงูู! ๐ ุจููุดู ููุณุงูุฉ 6650 ููุ ูุงูุญุถุงุฑุฉ ุงููุตุฑูุฉ ูููุง ุจุฏุฃุช ุนูู ุถูุงูู ูู ุขูุงู ุงูุณููู. ุดุฑุจุช ููู ุงูููุงุฑุฏุฉุ ๐๐ง",
    "ุงูุงูุฑุงูุงุช": "ุงูุงูุฑุงูุงุช ุฏู ูุนุฌุฒุฉ ุญููููุฉ! ๐บ ูุฑู ุฎููู ูุงู ุฃุทูู ุจูุงุก ูู ุงูุนุงูู ูุขูุงู ุงูุณููู. ุงุชุจูุช ุจุฏูุฉ ุฎุฑุงููุฉ ูุณู ุงูุนููุงุก ุจูุญุงูููุง ูููููุง ุณุฑูุง ูุญุฏ ุงูููุงุฑุฏุฉ! ๐๏ธโจ",
    "ุฐูุจ": "ูุตุฑ ุบููุฉ ุฌุฏุงู ุจุงูุฐูุจ! ๐ฐ ููุฌู ุงูุณูุฑู ูู ุงูุตุญุฑุงุก ุงูุดุฑููุฉ ูู ุฃูู ุงูููุงุฌูุ ูุงููุฑุงุนูุฉ ูุงู ุนูุฏูู ุจุฑุงุนุฉ ูุฐููุฉ ูู ุชุตููุน ุงูุฐูุจ ุฒู ููุงุน ุชูุช ุนูุฎ ุขููู! ๐",
    "ุนุงุตูู ูุตุฑ": "ุงููุงูุฑุฉ ูู ุงูุนุงุตูุฉุ ููู ูุฏููุฉ ุงูุฃูู ูุฆุฐูุฉ! ๐๏ธ ููุจ ูุตุฑ ุงููุงุจุถ ุงููู ุจูุฌูุน ุจูู ุงูุชุงุฑูุฎ ุงููุฏูู ูุงูุญุฏุงุซุฉ ููู ุญุงุฌุฉ ุฌูููุฉ! โค๏ธ",
    "ุดูุฑุง": "ุงูุนูู ูุง ุจุทู! ๐ฆ๐ ุฃูุง ููุฌูุฏ ุฏุงููุงู ุนุดุงู ุฃุณุงุนุฏู. ูู ุนูุฏู ุณุคุงู ุชุงูู ุฃูุง ุฌุงูุฒ! โจ",
    "ุจุญุจู": "ูุฃูุง ููุงู ุจุญุจู ูุง ูุณุชูุดู! ๐ฆโค๏ธ ููุง ุจููุง ูููู ุฑุญูุชูุง ููุนุฑู ุฃูุชุฑ ุนู ุฃุฌูู ุจูุฏ ูู ุงูุนุงูู! ๐ช๐ฌ",
};

export async function askZizo(userMessage, history = []) {
    const rawQuery = userMessage.toLowerCase();
    const query = normalizeArabic(rawQuery);

    // Dynamically fetch the API key to pick up changes
    const apiKey = (import.meta.env.VITE_GEMINI_API_KEY || "").trim();
    const isValidKey = apiKey && apiKey !== "your_key_here" && apiKey.startsWith("AIza");

    if (isValidKey) {
        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            const chat = model.startChat({
                history: history.map(msg => ({
                    role: msg.role === "zizo" ? "model" : "user",
                    parts: [{ text: msg.text }],
                })),
                generationConfig: { maxOutputTokens: 500 },
            });

            const fullPrompt = history.length === 0
                ? `${SYSTEM_PROMPT}\n\nุงูุณุคุงู: ${userMessage}`
                : userMessage;

            const result = await chat.sendMessage(fullPrompt);
            const response = await result.response;
            const text = response.text();

            if (text) return text;
        } catch (error) {
            console.error("DEBUG - Zizo AI Error Details:", error);

            // If it's a 403 or API_KEY_INVALID, give a more specific hint
            if (error.message?.includes("403") || error.message?.includes("permission")) {
                return "ูุง ุจุทู! ๐ฆ ุงูููุชุงุญ ุดุบุงู ุจุณ ููู ูุดููุฉ ูู ุงูุตูุงุญูุงุช. ุงุชุฃูุฏ ุฅูู ููุนู ุงูู Generative Language API ูู ููุญุฉ ุงูุชุญูู ุจุฌูุฌู. โจ";
            }
            if (error.message?.includes("400") || error.message?.includes("key")) {
                return "ูุง ูุณุชูุดู! ๐ฆ ููู ุญุงุฌุฉ ุบูุท ูู ุดูู ุงูููุชุงุญ. ุฌุฑุจ ุชูุณุฎู ูุชุฃูุฏ ุฅูู ูููุด ูุณุงูุงุช ุฒูุงุฏุฉุ ๐";
            }
        }
    }

    // --- Fallback Logic with Normalization ---
    for (const [key, val] of Object.entries(SMART_FALLBACK)) {
        if (query.includes(normalizeArabic(key))) return val;
    }

    // Handle Math
    if (rawQuery.match(/\d+\s*[\+\-\*\/รรท]\s*\d+/)) {
        try {
            const cleanQ = rawQuery.replace(/ร/g, '*').replace(/รท/g, '/');
            const result = eval(cleanQ);
            return `ุงูุญุณุงุจ ุฏู ุณูู ุฌุฏุงู! ๐ ุงูุญุณุจุฉ = ${result} ๐งฎโจ ุนุงูุฒ ุชุญุณุจ ุญุงุฌุฉ ุชุงููุฉุ`;
        } catch {
            return "ูุง ุจุทูุ ุงูุนูููุฉ ุงูุญุณุงุจูุฉ ุฏู ูููุง ุญุงุฌุฉ ูุด ูุธุจูุทุฉ. ุฌุฑุจ ุชูุชุจูุง ุชุงูู ุจูุถูุญุ ๐งฎโจ";
        }
    }

    if (!isValidKey) {
        return `ูุง ูุณุชูุดู! ๐ฆ ุฃูุง ุฐูู ุฌุฏุงู ุจุณ "ููุชุงุญ ุงูุฐูุงุก ุงูุงุตุทูุงุนู" ุจุชุงุนู ูุด ูุชูุนู ุตุญ ูู ููู (.env). ๐\n\nูุนุดุงู ุฃูุฏุฑ ุฃุฌุงูุจู ุนูู "ุฃู ุญุงุฌุฉ ูู ุงูุฏููุง" ูุงุฒู ุชุญุท ููุชุงุญ ุงูู API ุงูุฎุงุต ุจู Gemini ูู ููู .env.\n\nุฌุฑุจ ุชุณุฃููู ุฏูููุชู ุนู:\nโข ููุฑ ุงููููุ ุงูุงูุฑุงูุงุชุ ุงูุฐูุจ ๐๏ธ\nโข ุงูุนุงุตูุฉุ ุฃู ูุณุงุฆู ุญุณุงุจูุฉ ๐งฎ`;
    }

    return "ุณุคุงู ุฐูู ูุง ุจุทู! ๐ค ุฃูุง ุญุงููุงู ุนูุฏู ูุดููุฉ ุชูููุฉ ูู ุงูุงุชุตุงู ุจูุฎู ุงููุจูุฑ (ุฌูุฌู Gemini)ุ ูุฏู ูููู ูููู ุจุณุจุจ ุงูุตูุงุญูุงุช ุฃู ุงูุดุจูุฉ. \n\nุจุณ ุฃูุง ูุณู ูุงูุฑ ูุชูุฑ! ุฌุฑุจ ุชุณุฃููู ุนู ุงูุฌุบุฑุงููุง ุฃู ุงูุชุงุฑูุฎ ุฃู ุงูุญุณุงุจ ููุฑุฏ ุนููู ููุฑุงู! ๐โจ";
}
